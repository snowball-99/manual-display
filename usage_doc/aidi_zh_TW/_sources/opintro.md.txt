# 實操教程
**（以檢測+分割為例）**

### 1.用戶檢測需求確認
（1）參考“工具介紹”章節，了解AIDI模組應用場景和不同輸出結果區別
（2）了解終端用戶檢測需求
（3）根據終端用戶需求，構建AIDI檢測方案。
      
範例專案項目需求：產品屬於衝壓件，在衝壓過程中會產生破損缺陷，需要視覺檢測出NG產品，以便踢料工位將NG產品踢出。

下文以“檢測+分割”檢測方案為例進行實操演示，首先使用“檢測”模組檢出產品位置，然後使用“分割”模組檢測產品上缺陷位置 

### 2.AIDI專案建立建立

（1）AIDI左上角選擇”新建專案“
（2）本地工作區管理中選擇“加載其他”，選擇本地檔案，完成工作區創建。
（3）右擊工作區檔案創建新的專案，輸入新建專案名字。
為了便於管理和維護，項目現場專案通常會創建在一個工作區下。

![Alt text](image-397.png)
![Alt text](image-399.png)

### 3.數據導入
在”輸入“節點， 點擊“導入影像”，添加訓練模型所必須的影像數據。

![Alt text](image-398.png)

### 4.選擇模組
點擊“輸入”模組後的“+”，根據項目需求，選擇對應模組。下圖以“檢測”模組為例。

![Alt text](image-400.png)
     
### 5.視圖視窗設定       
（1）視圖窗口用於選定產品/缺陷的檢測區域。（產品/缺陷可能出現在影像上任何位置，則不需要更改檢測區域，直接點擊應用即可）
（2）確定檢測區域後，點擊應用。
（3）進入模組後，視圖範圍外區域會被遮罩，避免視圖外區域對模型識別效果產生干擾。

![Alt text](image-428.png)![Alt text](image-429.png)

### 6.數據標註
（1）設定標籤：在標註管理區的標籤管理內逐一設定好需要標註的缺陷或目標名稱。
（2）點擊標籤，可以進行修改、刪除、合併等功能。

![Alt text](image-430.png)

（3）標註管道
自由框：按一下後斜拉畫出任意矩形框標註。彈出標籤框後選擇標籤名稱，標註完成。
標準框：點擊直接放置固定大小的矩形框標註，可以調整矩形框的寬、高。彈出標籤框後選擇標籤名稱，標註完成。
標註框儘量貼緊需要檢測區域邊緣。CTRL+S或S鍵保存標註，保存後會自動跳轉到下一張圖片

![Alt text](image-431.png)

![Alt text](image-432.png)

### 7.訓練參數
（1）訓練集劃分
方式1：對所有影像完成標註後，在“模型訓練助手”中，選擇“數據劃分”。
軟體可以根據設定比例，隨機挑選製定比例的訓練集和測試。如圖中比例為70%，代表標註的數據中70%作為訓練集，30%作為測試集

![Alt text](image-433.png)
![Alt text](image-434.png)


方式2：在影像清單中，滑鼠右擊影像，加入訓練集。
模型第一次訓練完成後，需要採用“方式2”人工挑選4-5張具有代表性過/漏檢影像，新增進訓練集中進行優化，不能使用“方式1”挑選訓練集。 如果模型效果不佳，需要採用方式2多次挑選影像進訓練集，多次進行模型優化。

![Alt text](image-435.png)



訓練集數據儘量滿足以下要求：
1、類別完備：訓練集中包含各種缺陷類型 
2、缺陷形態完備：如缺陷形狀、大小、位置、角度、亮度、對比度等盡可能全。每種形態最低數量是50張
3、單專案中影像尺寸盡可能一致
4、明顯一樣的缺陷影像可以移除
5、訓練模型，同一種缺陷建議50張圖像起


（2）訓練參數設定
在“訓練參數/推理參數”中，選擇合適的參數進行模型訓練/推理。
訓練次數：常用設定範圍在400-2000之間，訓練次數採用逐步增加方式。
如果訓練過程曲線沒有擬合，採用每次在原來訓練次數上增加400次訓練。現場常用訓練次數為1200次。
訓練批次：設定幾張訓練圖像為一批，進行模型訓練。批次越大，顯存佔用越高，模型效果可以提升。
最大邊長：設定影像長邊的尺寸縮放至指定尺寸，短邊等比例縮放。
假如影像大小為1024*512，參數設置為512後，輸入模型的圖像尺寸為512*256，該影像最大設定參數為1024。 
模型架構：快速檢測，模型結構簡易，訓練/推理時間少，常用於快速產品粗定位
高精度檢測，模型結構複雜，訓練/推理時間多，缺陷檢測難度高場景

![Alt text](image-436.png)

增廣參數：通過將訓練集圖片按照設定方式進行增廣，訓練過程中訓練集按照參數隨機變換，增加模型對不同狀態缺陷識別能力。滑鼠放置在！圖標上  ，可以查看參數效果範例。
        
![Alt text](image-438.png)
![Alt text](image-437.png)

![Alt text](image-439.png)
![Alt text](image-440.png)

（3）訓練/測試
訓練按鈕：完成訓練參數設定後，點擊訓練按鈕。訓練完成後會自動進行一次測試，或者點擊測試按鈕進行測試。

![Alt text](image-441.png)
![Alt text](image-442.png)

訓練過程中，需要停止訓練情況下。  可以點擊右上角訓練進度條中“終止”按鈕，終止模型訓練。 工程現場不要中途取消模型訓練，會導致效果不佳。

![Alt text](image-443.png)

### 8.推理參數設定
推理模式：快速啟動，啟動速度快，推理速度一般；（一般場景，使用模式）
極速推理，第一次啟動慢，並非軟體卡死，推理速度最快；（高速場景下，使用模式。可能造成識別結果不完整）
極速推理高精度，第一次啟動慢，並非軟體卡死，推理速度介於快速啟動和極速推理之間
最大目標數：設定推理結果最大數量。
當影像被背景干擾，檢測到多個結果框時，可以減小該值的設定，過濾掉得分較低檢測出結果
目標交疊率：多個檢測框重疊時，重疊率不超過此值。
當同一個位置出現多個檢測結果重疊時，可以減小該值的設定
特徵閾值：可以對不同類別缺陷的面積，最小外接矩形長邊/短邊，範圍進行過濾。

![Alt text](image-444.png)

### 9.在評估頁面，查看測試效果
“訓練過程曲線”：定位框誤差函數：數值越小，識別精度越高

![Alt text](image-445.png)

“混淆矩陣“：查看人工標註缺陷和模型識別結果類別，點擊對應數位可以快速篩選出對應圖像
矩陣橫向：人工標註缺陷類別
矩陣縱向：模型測試缺陷類別
區域級：對缺陷標註區域，模型識別區域進行計算。重疊率小於0.3代表該區域模型漏檢。
圖片級：對整張圖像進行結果判定。

![Alt text](image-446.png)![Alt text](image-447.png)

模型詳情：單圖測試耗用於評估專案模型推理時間，判斷否能達到現場節拍需求重要參數。

![Alt text](image-448.png)

### 10.新增模組
（1）點擊模組後“+”添加其他模組，將上一個模組識別結果作為下一個模組檢測區域。下圖“檢測”模組後，新增“分割”模組為例。         

![Alt text](image-449.png)

（2）在“分割”視圖視窗中，可以對上一個檢測結果的“寬”，“高”，“橫向偏移”，“縱向偏移”，“偏移角度”參數進行設定。
比如前一個“檢測”模組識別框尺寸存在波動，下一個模組視圖視窗區域通常會設定固定的“寬”，“高”參數，保證輸入分割模組區域大小一致。然後點擊“應用”轉到“分割”模組中進行缺陷標註，訓練。

![Alt text](image-450.png)

（3）在模組中參考“檢測模組”步驟，進行缺陷標註，訓練參數設定，測試參數設定，模型結果查看

![Alt text](image-451.png)

### 11.綜合判定
AI模組檢測完成後，添加綜合判定節點模組。可以對所有AI檢測結果設定過濾條件項，滿足條件缺陷判為指定類別，不滿足條件缺陷判為其他類別，最終輸出AIDI的綜合判定結果。
如下圖所示，在分割AI模組後添加綜合判定節點。

![Alt text](image-452.png)

選擇進入綜合判定的AI模組，然後在軟體右側選擇“自定義標準”。

![Alt text](image-453.png)![Alt text](image-454.png)

自定義標註框中，選擇判斷為NG標註。下圖為將分割模組中，缺陷面積大於50像素產品判為NG，不滿足標準的缺陷判為other。

![Alt text](image-455.png)

點擊測試按鈕，即可查看判斷結果。

![Alt text](image-456.png)

### 12.工廠模式
使用“工廠模式”，可以對大批量圖像進行離線測試。影像通過“輸入”模組輸入，經過每個AI模組進行推理後，綜合判定模組進行匯總/判定，獲得模型的最終結果。具體操作如下所示：
在工具列中選擇“工廠模式”。

![Alt text](image-457.png)

導入測試圖像，點擊“全域推理”按鈕，顯示軟體最終推理結果。

![Alt text](image-458.png)

點擊其他AI模組，可以顯示圖像在其他模組中推理結果，便於現場排查問題。

![Alt text](image-459.png)

### 13.匯出模型
在軟體中使用大量圖像測試，模型檢測效果較好。選擇“模型匯出”選項，設定“存儲路徑”和“模型名稱”。模型檔案保存到指定路徑中，方便現場部署和使用。

![Alt text](image-460.png)
![Alt text](image-461.png)

### 14.二次開發：
模型集成到視覺系統軟體中，參考“AIDI二次開發指南”或打開“AIDI-幫助-開發檔案”進行查看。
